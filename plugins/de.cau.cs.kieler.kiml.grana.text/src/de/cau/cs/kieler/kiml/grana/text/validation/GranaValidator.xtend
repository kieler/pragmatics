/*
 * generated by Xtext
 */
package de.cau.cs.kieler.kiml.grana.text.validation

import org.eclipse.xtext.validation.Check
import de.cau.cs.kieler.kiml.grana.text.grana.RangeJob
import de.cau.cs.kieler.kiml.grana.AnalysisService
import de.cau.cs.kieler.kiml.grana.text.grana.GranaPackage
import de.cau.cs.kieler.kiml.grana.text.grana.OutputType

//import org.eclipse.xtext.validation.Check

/**
 * Custom validation rules. 
 *
 * see http://www.eclipse.org/Xtext/documentation.html#validation
 */
class GranaValidator extends AbstractGranaValidator {

//  public static val INVALID_NAME = 'invalidName'
//
//	@Check
//	def checkGreetingStartsWithCapital(Greeting greeting) {
//		if (!Character.isUpperCase(greeting.name.charAt(0))) {
//			warning('Name should start with a capital', 
//					MyDslPackage.Literals.GREETING__NAME,
//					INVALID_NAME)
//		}
//	}


    @Check
    def checkRangeAnalysisComponentExists(RangeJob job) {
        val analysis = AnalysisService.getInstance.getAnalysis(job.rangeAnalysis.name)
        if (analysis != null) {
            if (job.rangeAnalysisComponent < 0) {
                error("Component must be >= 0.", GranaPackage.Literals.RANGE_JOB__RANGE_ANALYSIS_COMPONENT)
            }
            if ((analysis.components == null || analysis.components.isEmpty) && job.rangeAnalysisComponent != 0) {
                error("Selected range analysis has only a single component, 'component' must be 0.",
                    GranaPackage.Literals.RANGE_JOB__RANGE_ANALYSIS_COMPONENT)
            }
            if (!analysis.components.isEmpty && analysis.components.size <= job.rangeAnalysisComponent) {
                error("Selected range analysis has only " + analysis.components.size + " components.",
                    GranaPackage.Literals.RANGE_JOB__RANGE_ANALYSIS_COMPONENT)
            }
        }
    }
    
    @Check
    def checkRangeOptionUnique(RangeJob job) {
        val layoutOptions = job.layoutOptions.map[it.persistentEntries.map[it.key]].flatten.toSet
        val rangeOption = job.rangeOption
         
        if (layoutOptions.contains(rangeOption)) {
            error("Range option cannot be part of the original layout options.",
                GranaPackage.Literals.RANGE_JOB__RANGE_OPTION)
        }
    }
    
    @Check
    def checkCsvSerializeRequiresSingleRangeAnalysis(RangeJob job) {
        if (job.outputType == OutputType.CSV) {

            if (!job.rangeAnalyses.isEmpty) {
                error("CSV serialization only supports a single 'rangeanalysis', not multiple 'rangeanalyses'.",
                    GranaPackage.Literals.RANGE_JOB__RANGE_ANALYSES)
            }
            
        }
    }
}
